# Main monkeySMS server

## how to run

See in main Readme.md at the root of the repo. It's a meteor app

## Collections

The collections are defined in imports/collections.js. Those are internal collections. Users of the api typically only interract with the Messages Collections

### Messages 

An SMS message that was either received or sent by one of the devices

```js
{
    // Message status, can be : "PENDING","ON_DEVICE","SENDING","RECEIVED", "SENT" ,"CANCELLED","ERROR"
    "status" : "RECEIVED",
    
    // Numbers should always be in an explicit international format 
    "from" : "+336283500000",
    "to" : "+33628111111"
    "text" : "Content of the sms message",
    
    // Device that's responsible for *sending* this message, can be "tbd" in cases where the sender doesn't know where to send it from
    "deviceId" : "SitBSdNhn879ZNavn",
    
    // wether this message was sent or received
    "outbound" : false,
    // Who asked for this message to be send, could be "dashboard" (created by the web app), "device" (created by the android app) or "key" (created by a connected app)
    "source" : {
        "type" : "device",
        "id" : "SitBSdNhn879ZNavn"
    },
    
    // not used yet, means that the user saw this message already
    "seen" : true,
    // unique id, user id and timestamps
    "_id" : "Sj9WxiIUfSul",
    "google_user_id" : "100181150342250387898",
    "createdAt" : 1648374666906,
    "last_updated" : 1648754839905,
    
}


```

### Devices 

Represents a physical android phone or tablet, with the android app installed. 

```js
{
    // Unique id, generated by the backend
    "_id" : "SitBSdNhn879ZNavn",
    // Random chain of character that verifies the device
    "deviceSecret" : "3e708002b308ad7a75b253e3c8be4423",
    // Firebase cloud messaging token, to notify the phone when something's new 
    "FCMToken" : "cbeL85D0R1qTw7edcymEFX:APA91bEwoVJ",
    // Google id of the user who logged in on this phone
    "google_user_id" : "1001811506666666",
    // Automatically provided by the phone, used in the UI
    "deviceName" : "Redmi Note 7",
    // Provided by the android system, used to avoid listing the same phone
    // multiple times
    "androidId" : "aefa962f6666666",
    // Timestamps in milliseconds 
    "first_connection" : 1648754832034,
    "last_connection" : 1648755750907,
    "lastSync" : 1648755750907,
    // Phone numbers of the different SIM cards of the phone
    "userNumbers" : [
        "+33626666666"
    ],
    // phone prefixes corresponding to the userNumbers 
    "countryCodes" : [
        33
    ],
    // region codes corresponding to the userNumbers
    "regionCodes" : [
        "FR"
    ]
}
```

### Contacts

Represents a (phone number - name) pair. Imported from the user's phone, and used in the UI

```js
{
    "_id" : "5fnxBuifPMXeGhbMP",
    // this is the google user id of the person that has this contact in their adress book, not the google id of the contact
    "google_user_id" : "100181150000000",
    // Should be an international number
    "number" : "+336254800000",
    "createdAt" : 1648754839905,
    "last_updated" : 1648754839911,
    "name" : "Paul Ho",
    // Which device created this contact
    "source" : {
        "type" : "device",
        "id" : "SitBSdNhn879ZNavn"
    }
}

```

### ApiKeys 

Represents a grant to an external app to send messages in the name of a user. The app is then notified of changes to those 
messages by webhook calls

```javascript
{
    "_id" : "vTkGRFTLNutricgQq",
    // The actual secret 
    "key" : "5d7c22cbf6eea682e4547436fa0e015730eda0XXXXXXXXXXXXXXXX",
    // user id of the account giving the rights 
    "google_user_id" : "1001811503XXXXXXXXXXXXXXX",
    "createdAt" : 1648757093083,
    "uses" : 2,
    "lastUsed" : 1648757236491,
    // false if the key has been deleted, in which case it can't be user
    "active" : true,
    // this is where all news regarding the created messages will be sent.
    "webhook_callback_url" : "http://example.com/monkey_sms_callback",
    // Domain to which the key was sent. It's the domain of the webhook url
    "domain" : "example.com"
}



```

### NotificationReceivers 

Each item represents the rights to notify a user about incoming messages, via web notifications

```javascript
{
    "_id" : "epTp37CRns6S2sddw",
    "google_user_id" : "1001811503422000000",
    "endpoint" : "https://updates.push.services.mozilla.com/wpuXXXXXXXXXXXXX",
    "userDeviceDescription" : "Firefox on Ubuntu (desktop)",
    "content" : {
        "endpoint" : "https://updates.push.services.mozilla.com/wpuXXXXXXXXXXXXX",
        "expirationTime" : null,
        "keys" : {
            "auth" : "Cor7rRtE3bU4XXXXXX",
            "p256dh" : "BB3YN-aIfCil8cqdXCXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
        }
    }
}

```